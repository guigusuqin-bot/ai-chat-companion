<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’ è´¨å­ 2 å· Â· ç®¡ç†åå°ï¼ˆé˜¿é‡Œäº‘ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(145deg, #fce7f3, #f9a8d4, #f9a8d4);
      font-family: 'Noto Sans SC', sans-serif;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border-bottom: 1px solid #fbcfe8;
      padding: 8px 10px;
      text-align: left;
    }
    th {
      background: #f472b6;
      color: white;
    }
    tr:hover {
      background: rgba(255, 240, 245, 0.6);
    }
    button {
      background: linear-gradient(to right, #f472b6, #ec4899);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body class="p-4">
  <header class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold text-pink-700">ğŸ’ è´¨å­ 2 å· Â· é˜¿é‡Œäº‘è®°å¿†åå°</h1>
    <div>
      <button id="refreshBtn">ğŸ”„ åˆ·æ–°</button>
      <button id="exportBtn">ğŸ“¦ å¯¼å‡º CSV</button>
      <button id="logoutBtn">ğŸšª é€€å‡º</button>
    </div>
  </header>

  <section class="mb-4">
    <label class="font-semibold text-pink-700">ç­›é€‰ç”¨æˆ·ï¼š</label>
    <input id="filterUser" placeholder="è¾“å…¥ç”¨æˆ·å..." class="border border-pink-300 rounded px-2 py-1 w-48">
    <button id="filterBtn" class="ml-2">ç­›é€‰</button>
  </section>

  <table id="dataTable">
    <thead>
      <tr>
        <th>ç”¨æˆ·</th>
        <th>è§’è‰²</th>
        <th>å†…å®¹</th>
        <th>æ—¶é—´</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // === ğŸ” ç®¡ç†å‘˜èº«ä»½æ£€æŸ¥ ===
    const user = localStorage.getItem("proton_user");
    const isAdmin = localStorage.getItem("is_admin") === "true";
    if (!isAdmin || user !== "Ccc") {
      alert("âš ï¸ éç®¡ç†å‘˜è´¦å·ï¼Œç¦æ­¢è®¿é—®ï¼");
      window.location.href = "login.html";
    }

    const tbody = document.querySelector("#dataTable tbody");
    const refreshBtn = document.getElementById("refreshBtn");
    const exportBtn = document.getElementById("exportBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const filterBtn = document.getElementById("filterBtn");

    const SERVER_API = "http://47.83.127.203/api.php";

    // === ä»é˜¿é‡Œäº‘æœåŠ¡å™¨åŠ è½½æ•°æ® ===
    async function loadData(filterUser = "") {
      tbody.innerHTML = "<tr><td colspan='4'>â³ æ­£åœ¨åŠ è½½æ•°æ®...</td></tr>";
      try {
        const res = await fetch(SERVER_API);
        const data = await res.json();

        if (data.status !== "success") throw new Error("API å“åº”å¼‚å¸¸");
        let list = data.data;

        if (filterUser) {
          list = list.filter(item => item.user && item.user.includes(filterUser));
        }

        if (!list || list.length === 0) {
          tbody.innerHTML = "<tr><td colspan='4'>æš‚æ— æ•°æ®</td></tr>";
          return;
        }

        tbody.innerHTML = list.map(row => `
          <tr>
            <td>${row.user || "(æœªçŸ¥)"}</td>
            <td>${row.role || "-"}</td>
            <td>${row.content || "(ç©º)"}</td>
            <td>${row.timestamp || "-"}</td>
          </tr>
        `).join("");
      } catch (err) {
        console.error("âŒ æ•°æ®åŠ è½½å¤±è´¥", err);
        tbody.innerHTML = `<tr><td colspan='4'>åŠ è½½å¤±è´¥ï¼š${err.message}</td></tr>`;
      }
    }

    // === å¯¼å‡º CSV ===
    function exportCSV() {
      let csv = "ç”¨æˆ·,è§’è‰²,å†…å®¹,æ—¶é—´\n";
      document.querySelectorAll("#dataTable tbody tr").forEach(tr => {
        const cells = Array.from(tr.querySelectorAll("td"))
          .map(td => `"${td.innerText.replace(/"/g, '""')}"`);
        csv += cells.join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "proton2_memory_export.csv";
      a.click();
    }

    // === ç»‘å®šæŒ‰é’®äº‹ä»¶ ===
    refreshBtn.onclick = () => loadData();
    exportBtn.onclick = () => exportCSV();
    filterBtn.onclick = () => {
      const u = document.getElementById("filterUser").value.trim();
      loadData(u);
    };
    logoutBtn.onclick = () => {
      localStorage.clear();
      window.location.href = "login.html";
    };

    // === å¯åŠ¨æ—¶åŠ è½½ ===
    loadData();
  </script>
</body>
</html>
